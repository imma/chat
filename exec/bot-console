#!/usr/bin/env bash

function main {
  local shome="$(cd -P -- "${BASH_SOURCE%/*}/.." && pwd -P)"

  stty -echo
  trap 'stty echo' EXIT

  coproc tail { tail -f "$shome/log/console.log"; }
  exec 4<&${tail[0]}

  local nm_channel='#immanent'

  IFS=
  accum=
  d=
  while true; do 
    if [[ -n "${accum:-}" ]]; then
      stty echo
      if read -p "${nm_channel} " -r -e -i "$accum" d; then
        accum="${d}"

        case "$accum" in
          /*)
            case "$accum" in
              /channel\ *)
                nm_channel="${accum#* }"
                ;;
              /join\ *)
                nm_channel="${accum#* }"
                echo "JOIN ${nm_channel}" > "$shome/tmp/input.tmp"
                ;;
              *)
                echo "UNHANDLED: $accum"
                ;;
            esac
            ;;
          *)
            echo "PRIVMSG ${nm_channel} :$accum" > "$shome/tmp/input.tmp"
            ;;
        esac

        while [[ -f "$shome/tmp/input.txt" ]]; do
          sleep 1
        done

        if [[ -f "$shome/tmp/input.tmp" ]]; then
          mv "$shome/tmp/input.tmp" "$shome/tmp/input.txt"
          cat "$shome/tmp/input.txt"
        fi

        accum=
      fi
    else
      stty -echo
      if read -t 1 -N 1 -r -s d; then
        accum="${d}"
        continue
      fi

      while true; do
        if read -t 1 -u 4 -r console; then
          echo "$console"
        else
          break
        fi
      done
    fi
  done

}

source sub "$BASH_SOURCE" "$@"
